<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta name="author" content="Stephen Gould"/>
<title>Coach's Assistant</title>
<link rel="stylesheet" href="body.css" type="text/css"/></head>
<script type="text/javascript">
// extract query string
var urlParams;
(window.onpopstate = function () {
    var match,
        pl = /\+/g,
        search = /([^&=]+)=?([^&]*)/g,
        //search = /([^?&=]+)=([^&]*)/g,
        decode = function (s) { return decodeURIComponent(s.replace(pl, " ")); },
        query  = window.location.search.substring(1);

    urlParams = {};
    while (match = search.exec(query))
       urlParams[decode(match[1])] = decode(match[2]);
})();

// configuration
var config = {resetSeconds: 20 * 60, updateInerval: 5, vibrateInterval: 0, names: []};
if ("json" in urlParams) {
  config = JSON.parse(urlParams["json"]);
}
if ((config.resetSeconds <= 0) || isNaN(config.resetSeconds)) config.resetSeconds = 20 * 60;
if ((config.updateInterval <= 0) || isNaN(config.updateInterval)) config.updateInterval = 1;
if ((config.vibrateInterval <= 0) || isNaN(config.vibrateInterval)) config.vibrateInterval = 0;
if (config.names.length == 0) {
  for (var i = 0; i < 10; i++) {
    config.names.push("Player " + (i + 1));
  }
}

// game state (global)
var gridView = ("gd" in urlParams ? true : false);
var highContrast = ("hc" in urlParams ? true : false);
var timerId = null;
var gameSeconds = config.resetSeconds;
var flasher = false;
players = [];

var bgColourActive = "#d0ffd0";
var bgColourInactive = "#ffd0d0";
var bgColourActiveHC = "#f0f0f0";
var bgColourInactiveHC = "#000000";

function sec2text(s) {
  var mm = Math.floor(s / 60);
  if (mm < 10) mm = '0' + mm;
  var ss = s % 60;
  ss = config.updateInterval * Math.floor(ss / config.updateInterval);
  if (ss < 10) ss = '0' + ss;
  if ((timerId != null) && flasher)
    return mm + " " + ss;
  return mm + ":" + ss;
}

function initializeGame() {
  if (timerId != null) {
    clearInterval(timerId)
    timerId = null;
    flasher = false;
  }
  gameSeconds = config.resetSeconds;

  players = [];
  for (var i = 0; i < config.names.length; i++) {
    if (config.names[i].length == 0) continue;
    var p = {name: config.names[i].trim(), totalTime: 0, currTime: 0, active: true};
    players.push(p);
  }
  
  initPlayerView();
  update();
}

function initPlayerView() {
  var table = document.getElementById("players_table");
  // delete existing rows
  for (var i = table.rows.length - 1; i >= 0; i--) {
    table.deleteRow(i);
  }

  // add new rows
  if (gridView) {
    for (var i = 0; i < players.length / 2; i++) {
      var row = table.insertRow(i);
      row.insertCell(0); row.insertCell(1);
    }

    for (var i = 0; i < players.length; i++) {
      var c = table.rows[Math.floor(i / 2)].cells[i % 2];
      c.innerHTML = "<b>" + players[i].name + "</b><br><small>(" + sec2text(0) + ") &nbsp; (" + sec2text(0) + ")</small>";
      c.style.width="160px";
      c.style.textAlign="center";
      var fcn = "function(){togglePlayer(" + i + "); return true;}";
      eval("c.addEventListener('click', " + fcn + ");");
    }
  } else {
    var header = ["Player Name", "Time Played", "Last Change"];
    var row = table.insertRow(0);
    for (var i = 0; i < 3; i++) {
      var th = document.createElement("th");
      th.appendChild(document.createTextNode(header[i]));
      var fcn = "function(){sortBy(" + i + "); return true;}";
      eval("th.addEventListener('click', " + fcn + ");");
      row.appendChild(th);
    }

    for (var i = 0; i < players.length; i++) {
      var row = table.insertRow(i + 1);
      row.insertCell(0).appendChild(document.createTextNode(players[i].name));
      row.insertCell(1).appendChild(document.createTextNode(sec2text(0)));
      row.insertCell(2).appendChild(document.createTextNode(sec2text(0)));
      row.cells[1].style.textAlign="right";
      row.cells[2].style.textAlign="right";
      var fcn = "function(){togglePlayer(" + i + "); return true;}";
      eval("row.addEventListener('click', " + fcn + ");");
    }
  }
}

function showConfig() {
  document.getElementById("main").style.display = "none";
  document.getElementById("config").style.display = "block";
}

function hideConfig() {
  document.getElementById("main").style.display = "block";
  document.getElementById("config").style.display = "none";

  config.names = document.getElementById("input_names").value.split("\n");
  config.resetSeconds = Math.floor(document.getElementById("input_tm").value * 60);
  config.updateInterval = Math.floor(document.getElementById("input_up").value);
  config.vibrateInterval = Math.floor(document.getElementById("input_vb").value * 60);
  if ((config.resetSeconds < 0) || isNaN(config.resetSeconds)) {
    config.resetSeconds = 0;
    document.getElementById("input_tm").value = 0;
  }
  if ((config.updateInterval < 1) || isNaN(config.updateInterval)) {
    config.updateInterval = 1;
    document.getElementById("input_up").value = 1;
  }
  if ((config.vibrateInterval < 0) || isNaN(config.vibrateInterval)) {
    config.vibrateInterval = 0;
    document.getElementById("input_vb").value = 0;
  }
  // TODO: move to URL with: encodeURIComponent(JSON.stringify(config));
}

function toggleView() {
  gridView = !gridView;
  initPlayerView();
  update();
}

function toggleContrast() {
  highContrast = !highContrast;
  update();
}

function togglePlayer(id) {
  players[id].active = !players[id].active;
  players[id].currTime = 0;
  update();
}

function clockStartStop() {
  if (timerId != null) {
    clearInterval(timerId)
    timerId = null;
  } else {
    timerId = setInterval(onTimer, 1000);
  }
  update();
}

function clockReset() {
  if (timerId != null) return;
  initializeGame();
  update();
}

function sortBy(field) {
  switch (field) {
    case 0: players.sort(function(a, b){return a.name.localeCompare(b.name)}); break;
    case 1: players.sort(function(a, b){return a.totalTime - b.totalTime}); break;
    case 2: players.sort(function(a, b){return a.currTime - b.currTime}); break;
  }
  initPlayerView();
  update();
}

function onTimer() {
  // game clock
  gameSeconds -= 1;
  if ((config.vibrateInterval > 0) && (gameSeconds % config.vibrateInterval == 0)) {
    navigator.vibrate = navigator.vibrate || navigator.webkitVibrate || navigator.mozVibrate || navigator.msVibrate;
    navigator.vibrate([500]);
  }
  if (gameSeconds < 0) gameSeconds = 0;
  flasher = !flasher;

  // players
  for (var i = 0; i < players.length; i++) {
    players[i].currTime += 1;
    if (players[i].active)
      players[i].totalTime += 1;
  }

  // update gui
  update();
}

function update() {
  // update game clock
  var mm = Math.floor(gameSeconds / 60);
  if (mm < 10) mm = '0' + mm;
  var ss = gameSeconds % 60;
  if (ss < 10) ss = '0' + ss;
  document.getElementById("game_minutes").innerHTML = mm;
  document.getElementById("game_seconds").innerHTML = ss;

  if (timerId == null) {
    document.getElementById("game_timer").style.color = "black";
    document.getElementById("start_stop_button").className = "green button";
    document.getElementById("start_stop_button").innerHTML = "start";
    document.getElementById("reset_button").className = "red button";
  } else {
    document.getElementById("start_stop_button").className = "red button";
    document.getElementById("start_stop_button").innerHTML = "stop";
    document.getElementById("reset_button").className = "disabled_button";
    if ((gameSeconds == 0) && flasher) {
      document.getElementById("game_timer").style.color = "#fff0f0";
    } else {
      document.getElementById("game_timer").style.color = "black";
    }
  }

  // update players
  var table = document.getElementById("players_table");
  if (gridView) {
    for (var i = 0; i < players.length; i++) {
      var c = table.rows[Math.floor(i / 2)].cells[i % 2];
      c.innerHTML = "<b>" + players[i].name + "</b><br><small>(" +
        sec2text(players[i].totalTime) + ") &nbsp; (" + sec2text(players[i].currTime) + ")</small>";
      if (players[i].active) {
        c.style.color = "black";
        c.style.backgroundColor = (highContrast ? bgColourActiveHC : bgColourActive);
      } else {
        c.style.color = "grey";
        c.style.backgroundColor = (highContrast ? bgColourInactiveHC : bgColourInactive);
      }
    }
  } else {
    for (var i = 0; i < players.length; i++) {
      var row = table.rows[i + 1];
      if (players[i].active) {
        row.style.color = "black";
        row.style.backgroundColor = (highContrast ? bgColourActiveHC : bgColourActive);
      } else {
        row.style.color = "grey";
        row.style.backgroundColor = (highContrast ? bgColourInactiveHC : bgColourInactive);
      }
      row.cells[1].innerHTML = sec2text(players[i].totalTime);
      row.cells[2].innerHTML = sec2text(players[i].currTime);
    }
  }
}
</script>
<body onload="if ('json' in urlParams) { initializeGame(); } else { showConfig(); }">

<div id="main">
<span class="game_title">Coach's Assistant</span>
<br>
<div class="game_timer" id="game_timer">
<span id="game_minutes">20</span>:<span id="game_seconds">00</span>
</div>
<a href="#" class="green button" id="start_stop_button" onClick="clockStartStop(); return true;">start</a>
<a href="#" class="red button" id="reset_button" onClick="clockReset(); return true;">reset</a>
<p>

<center>
<table class="players_table" id="players_table">
</table>
<small style="color:#7f7f7f;">
[tap name on/off; tap header to re-sort]
<br>
<span onClick="showConfig();">(&olarr; configure)</span>
&nbsp;
<span onClick="toggleView();">(&sharp; grid/list)</span>
&nbsp;
<span onClick="toggleContrast();">(&square; contrast)</span>
</small>
<br>
</center>
<p>
</div>

<div id="config" style="display:none;">
<span class="game_title">Coach's Assistant Configuration</span>
<p>

<center>
<table>
<tr>
<td><b>Game Time:&nbsp;</b></td>
<td><input type="text" id="input_tm" value="20" size="3"> minutes</td>
</tr>
<tr>
<td><b>Update Interval:&nbsp;</b></td>
<td><input type="text" id="input_up" value="1" size="3"> seconds</td>
</tr>
<tr>
<td><b>Vibrate Interval:&nbsp;</b></td>
<td><input type="text" id="input_vb" value="0" size="3"> minutes</td>
</tr>
</table>
</center>
<p>

<b>Players:</b><br>
<textarea rows="10" cols="25" id="input_names">
Player 1
Player 2
Player 3
Player 4
Player 5
Player 6
Player 7
Player 8
Player 9
Player 10
</textarea>
<p>

<a href="#" class="blue wide_button" id="update_button" onClick="hideConfig(); initializeGame(); return true;">game on</a>
<p>
<small style="color:#7f7f7f;">
<b>Tip:</b> After clicking the "game on" button bookmark the page<br>
for quick access to this configuration in the future.
</small>

</div>

<address><small>
Copyright &copy; 2015, Stephen Gould.
</small></address>
</body>
</html>
