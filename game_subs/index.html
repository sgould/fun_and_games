<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta name="author" content="Stephen Gould"/>
<title>Coach's Assistant</title>
<link rel="stylesheet" href="body.css" type="text/css"/></head>
<script type="text/javascript">
// extract query string
var urlParams;
(window.onpopstate = function () {
    var match,
        pl = /\+/g,
        search = /([^&=]+)=?([^&]*)/g,
        //search = /([^?&=]+)=([^&]*)/g,
        decode = function (s) { return decodeURIComponent(s.replace(pl, " ")); },
        query  = window.location.search.substring(1);

    urlParams = {};
    while (match = search.exec(query))
       urlParams[decode(match[1])] = decode(match[2]);
})();

// url or defaults
var resetSeconds = ("tm" in urlParams ? Number(urlParams["tm"]) : 20 * 60);
if ((resetSeconds <= 0) || isNaN(resetSeconds)) resetSeconds = 20 * 60;
var gridView = ("gd" in urlParams ? true : false);
var highContrast = ("hc" in urlParams ? true : false);
var playerTimerResolution = ("up" in urlParams ? urlParams["up"] : 5);
if ((playerTimerResolution <= 0) || isNaN(playerTimerResolution)) playerTimerResolution = 1;
// TODO: parse player names
// TODO: config should return a URL to maintain state
var vibrateTimeout = ("vb" in urlParams ? urlParams["vb"] : resetSeconds);

// globals
var timerId = null;
var gameSeconds = resetSeconds;
var players = [];
var flasher = false;

var bgColourActive = "#d0ffd0";
var bgColourInactive = "#ffd0d0";
var bgColourActiveHC = "#f0f0f0";
var bgColourInactiveHC = "#000000";

function sec2text(s) {
  var mm = Math.floor(s / 60);
  if (mm < 10) mm = '0' + mm;
  var ss = s % 60;
  ss = playerTimerResolution * Math.floor(ss / playerTimerResolution);
  if (ss < 10) ss = '0' + ss;
  if ((timerId != null) && flasher)
    return mm + " " + ss;
  return mm + ":" + ss;
}

function initializeGame() {
  if (timerId != null) {
    clearInterval(timerId)
     timerId = null;
     flasher = false;
  }
  gameSeconds = resetSeconds;

  var names = document.getElementById("player_names").value.split("\n");
  players = [];
  for (var i = 0; i < names.length; i++) {
    if (names[i].length == 0) continue;
    var p = Object();
    p.name = names[i].trim();
    p.totalTime = 0;
    p.currTime = 0;
    p.active = true;
    players.push(p);
  }

  initPlayerView();
  update();
}

function initPlayerView() {
  var table = document.getElementById("players_table");
  // delete existing rows
  for (var i = table.rows.length - 1; i >= 0; i--) {
    table.deleteRow(i);
  }

  // add new rows
  if (gridView) {
    for (var i = 0; i < players.length / 2; i++) {
      var row = table.insertRow(i);
      row.insertCell(0); row.insertCell(1);
    }

    for (var i = 0; i < players.length; i++) {
      var c = table.rows[Math.floor(i / 2)].cells[i % 2];
      c.innerHTML = "<b>" + players[i].name + "</b><br><small>(" + sec2text(0) + ") &nbsp; (" + sec2text(0) + ")</small>";
      c.style.width="160px";
      c.style.textAlign="center";
      var fcn = "function(){togglePlayer(" + i + "); return true;}";
      eval("c.addEventListener('click', " + fcn + ");");
    }
  } else {
    var header = ["Player Name", "Time Played", "Last Change"];
    var row = table.insertRow(0);
    for (var i = 0; i < 3; i++) {
      var th = document.createElement("th");
      th.appendChild(document.createTextNode(header[i]));
      var fcn = "function(){sortBy(" + i + "); return true;}";
      eval("th.addEventListener('click', " + fcn + ");");
      row.appendChild(th);
    }

    for (var i = 0; i < players.length; i++) {
      var row = table.insertRow(i + 1);
      row.insertCell(0).appendChild(document.createTextNode(players[i].name));
      row.insertCell(1).appendChild(document.createTextNode(sec2text(0)));
      row.insertCell(2).appendChild(document.createTextNode(sec2text(0)));
      row.cells[1].style.textAlign="right";
      row.cells[2].style.textAlign="right";
      var fcn = "function(){togglePlayer(" + i + "); return true;}";
      eval("row.addEventListener('click', " + fcn + ");");
    }
  }
}

function showConfig() {
  document.getElementById("main").style.display = "none";
  document.getElementById("config").style.display = "block";
}

function hideConfig() {
  document.getElementById("main").style.display = "block";
  document.getElementById("config").style.display = "none";
}

function toggleView() {
  gridView = !gridView;
  initPlayerView();
  update();
}

function toggleContrast() {
  highContrast = !highContrast;
  update();
}

function togglePlayer(id) {
  players[id].active = !players[id].active;
  players[id].currTime = 0;
  update();
}

function clockStart() {
  if (timerId) return;
  timerId = setInterval(onTimer, 1000);
  update();
}

function clockStop() {
  // reset if timer is null
  if (timerId == null) {
    initializeGame();
  }
  clearInterval(timerId)
  timerId = null;
  update();
}

function sortBy(field) {
  switch (field) {
    case 0: players.sort(function(a, b){return a.name.localeCompare(b.name)}); break;
    case 1: players.sort(function(a, b){return a.totalTime - b.totalTime}); break;
    case 2: players.sort(function(a, b){return a.currTime - b.currTime}); break;
  }
  initPlayerView();
  update();
}

function onTimer() {
  // game clock
  gameSeconds -= 1;
  if (gameSeconds % vibrateTimeout == 0) {
    navigator.vibrate = navigator.vibrate || navigator.webkitVibrate || navigator.mozVibrate || navigator.msVibrate;
    navigator.vibrate([500]);
  }
  if (gameSeconds < 0) gameSeconds = 0;
  flasher = !flasher;

  // players
  for (var i = 0; i < players.length; i++) {
    players[i].currTime += 1;
    if (players[i].active)
      players[i].totalTime += 1;
  }

  // update gui
  update();
}

function update() {
  // update game clock
  var mm = Math.floor(gameSeconds / 60);
  if (mm < 10) mm = '0' + mm;
  var ss = gameSeconds % 60;
  if (ss < 10) ss = '0' + ss;
  document.getElementById("game_minutes").innerHTML = mm;
  document.getElementById("game_seconds").innerHTML = ss;

  if (timerId == null) {
    document.getElementById("game_timer").style.color = "black";
    document.getElementById("stop_button").innerHTML = "reset";
  } else {
    document.getElementById("stop_button").innerHTML = "stop";
    if ((gameSeconds == 0) && flasher) {
      document.getElementById("game_timer").style.color = "#fff0f0";
    } else {
      document.getElementById("game_timer").style.color = "black";
    }
  }

  // update players
  var table = document.getElementById("players_table");
  if (gridView) {
    for (var i = 0; i < players.length; i++) {
      var c = table.rows[Math.floor(i / 2)].cells[i % 2];
      c.innerHTML = "<b>" + players[i].name + "</b><br><small>(" +
        sec2text(players[i].totalTime) + ") &nbsp; (" + sec2text(players[i].currTime) + ")</small>";
      if (players[i].active) {
        c.style.color = "black";
        c.style.backgroundColor = (highContrast ? bgColourActiveHC : bgColourActive);
      } else {
        c.style.color = "grey";
        c.style.backgroundColor = (highContrast ? bgColourInactiveHC : bgColourInactive);
      }
    }
  } else {
    for (var i = 0; i < players.length; i++) {
      var row = table.rows[i + 1];
      if (players[i].active) {
        row.style.color = "black";
        row.style.backgroundColor = (highContrast ? bgColourActiveHC : bgColourActive);
      } else {
        row.style.color = "grey";
        row.style.backgroundColor = (highContrast ? bgColourInactiveHC : bgColourInactive);
      }
      row.cells[1].innerHTML = sec2text(players[i].totalTime);
      row.cells[2].innerHTML = sec2text(players[i].currTime);
    }
  }
}
</script>
<body onload="initializeGame();">

<div id="main">
<span class="game_title">Coach's Assistant</span>
<br>
<div class="game_timer" id="game_timer">
<span id="game_minutes">20</span>:<span id="game_seconds">00</span>
</div>
<a href="#" class="green button" id="start_button" onClick="clockStart(); return true;">start</a>
<a href="#" class="red button" id="stop_button" onClick="clockStop(); return true;">reset</a>
<p>

<center>
<table class="players_table" id="players_table">
</table>
<small style="color:#7f7f7f;">
[tap name on/off; tap header to re-sort]
<br>
<span onClick="showConfig();">(&olarr; configure)</span>
&nbsp;
<span onClick="toggleView();">(&sharp; grid/list)</span>
&nbsp;
<span onClick="toggleContrast();">(&square; contrast)</span>
</small>
<br>
</center>
<p>
</div>

<div id="config" style="display:none;">
<span class="game_title">Coach's Assistant Configuration</span>
<p>

<b>Game Time:</b><br>
<input type="text" id="input_time" value="20" size="3"> minutes
<p>

<b>Players:</b><br>
<textarea rows="10" cols="20" id="player_names">
Player 1
Player 2
Player 3
Player 4
Player 5
Player 6
Player 7
Player 8
Player 9
Player 10
</textarea>
<p>

<a href="#" class="blue button" id="update_button" onClick="initializeGame(); hideConfig(); return true;">start</a>
</div>

<address><small>
Copyright &copy; 2015, Stephen Gould.
</small></address>
</body>
</html>
