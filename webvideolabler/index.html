<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ANU CVML Video Annotation Tool</title>
    <link rel="stylesheet" href="anucvml.css" type="text/css"/>
    <script type="text/javascript" src="anuvidlib.js"></script>
    <script type="text/javascript">
        function todo() { window.alert("Not implemented yet!"); }
    </script>
    <script type="text/javascript">
        var v = null;

        function init() {
            v = new ANUVidLib("leftframe", "leftslider", "leftstatus", "rightframe", "rightslider", "rightstatus");

            var loadVideoFile = function(event) {
                var file = this.files[0];
                var fileURL = URL.createObjectURL(file);
                v.loadVideo(fileURL);
            }

            var input = document.querySelector('input');
            input.addEventListener('change', loadVideoFile, false);
        }

        function play() {
            if (isNaN(v.video.duration)) {
                return;
            }
            document.getElementById('overlay').style.display = 'block';
            var startTime = Math.min(v.leftPanel.timestamp, v.rightPanel.timestamp);
            var endTime = Math.max(v.leftPanel.timestamp, v.rightPanel.timestamp);
            document.getElementById('vidplayer').src = v.video.src + "#t=" + startTime + "," + endTime;
        }

        // defocus the current element when enter is pressed
        function defocusOnEnter(event) {
            if (event.keyCode == 13 || event.which == 13) {
                event.currentTarget.blur();
            }
        }

        function newclip() {
            var table = document.getElementById("vidsegtable");
            var row = table.insertRow(-1);
            row.insertCell(0).innerHTML = v.leftPanel.timestamp;
            row.insertCell(1).innerHTML = v.rightPanel.timestamp;
            var input = document.createElement("input");
            input.type = "text"; input.classList.add("segdesc");
            parent = row.insertCell(2);
            parent.appendChild(input);
            var cell = row.insertCell(3);
            cell.innerHTML = "<button title='delete' onclick='delclip(this.parentElement.parentElement);'>&#x2718;</button>";
            cell.innerHTML += " <button title='move up' onclick='todo();'>&#x1F819;</button>";
            cell.innerHTML += " <button title='move down' onclick='todo();'>&#x1F81B;</button>";
            cell.innerHTML += " <button title='goto' onclick='v.seekToTime(" +
                v.leftPanel.timestamp + ", " + v.rightPanel.timestamp + ", true);'>&#x270E;</button>";
            cell.style.textAlign = "right";
            input.onkeypress = function(event) { defocusOnEnter(event); }
            input.focus();
        }

        function delclip(row) {
            var table = document.getElementById("vidsegtable");
            table.deleteRow(row.rowIndex);
        }
    </script>
</head>
<body onload="init();">
<center>
<h1>ANU CVML In-browser Video Annotation Tool</h1>
</center>

<!-- video and annotation input -->
<input type="file" accept="video/*" />
<p/>

<!-- side-by-side video frame container -->
<div id="container" style="width: 100%;">
    <div id="leftpanel" style="width: 45%; float: left;">
        <div class="filmstrip"></div>
        <canvas id="leftframe" width="640px" height="480px" style="display: block;"></canvas>
        <div class="filmstrip"></div>
        <br>
        <div style="width: 100%;">
            <input type="range" min="0" max="100" value="0" style="width: 100%;" id="leftslider" oninput="v.seekToIndex(this.value, -1)";>
            <br>
            <span style="float: right;" id="leftstatus">none</span>
        </div>
    </div>
    <div id="centerpanel" style="width: 10%; float: left; text-align: center; position: relative;">
        <b>Annotations</b><br><p/>
        <button onclick="todo();" type="button" style="width: 50%;">&rarr;</button><p/>
        <button onclick="todo();" type="button" style="width: 50%;">&#8608;</button><p/>
        <br><p/>
        <button onclick="todo();" type="button" style="width: 50%;">&larr;</button><p/>
        <button onclick="todo();" type="button" style="width: 50%;">&#8606;</button><p/>
        <br><p/>
        <b>Tracking</b><br><p/>
        <input id="tiedcb" type="checkbox" onclick="v.tiedframes = this.checked; return true;">
        <label for="tiedcb">tie sliders</label><br>
        <br><p/>
        <b>Appearance</b><br><p/>
        <input id="greycb" type="checkbox" onclick="v.greyframes = this.checked; return true;">
        <label for="greycb">greyscale</label><br>
        <br><p/>
        <b>Segment</b><br><p/>
        <button onclick="v.seekToTime(v.rightPanel.timestamp, v.leftPanel.timestamp, true);" title="swap" type="button" style="width: 50%;">&#x21C4; swap</button><p/>
        <button onclick="play();" title="play" type="button" style="width: 50%;">&#x25B6; play</button><p/>
    </div>
    <div id="rightpanel" style="width: 45%; float:left;">
        <div class="filmstrip"></div>
        <canvas id="rightframe" width="640px" height="480px" style="display: block;"></canvas>
        <div class="filmstrip"></div>
        <br>
        <div style="width: 100%;">
            <input type="range" min="0" max="100" value="0" style="width: 100%;" id="rightslider" oninput="v.seekToIndex(-1, this.value)";>
            <br>
            <span style="float: right;" id="rightstatus">none</span>
        </div>
    </div>
    <!-- needed for proper alignment of previous divs -->
    <div style="clear: both;"></div>
</div>

<!-- annotations container -->
<div id="annotations" style="width: 100%;">
<fieldset style="background: #f7f7f7;">
<legend>Video segments</legend>
    <div style="float: right;">
        <button title="sort" onclick="todo();">&#x21A7; sort</button>
        <button title="add segment" onclick="newclip();">&#x271A;</button>
    </div>
    <div style="clear: both;"></div>
    <table id="vidsegtable" width="100%" style="table-layout: fixed;">
        <tr><th width="60pt">start</th><th width="60pt">end</th><th width="100%">description</th><th width="160pt" align="right"></th></tr>
    </table>
</fieldset>
</div>

<!-- overlay window -->
<div id="overlay">
    <span id="overlayclosebtn" onclick="document.getElementById('overlay').style.display = 'none';">x</span>
    <div class="centered">
        <div class="filmstrip"></div>
        <video style="width: 100%; display: block;" autoplay id="vidplayer"></video>
        <div class="filmstrip"></div>
        <button onclick="document.getElementById('vidplayer').load();" type="button" style="width: 10%; float: left;">&#x25B6; replay</button>
        <button onclick="document.getElementById('vidplayer').pause(); document.getElementById('overlay').style.display = 'none';" type="button" style="width: 10%; float: right;">&#x25FC; stop</button>
        <div style="clear: both;"></div>
    </div>
</div>

<p/>
<address>
    Copyright &copy; 2020, Stephen Gould. All rights reserved.<br>
    about | help | contact
</address>

</body>
</html>